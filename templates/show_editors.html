{% extends "layout.html" %}

{% block fixes %}
<div class="row">
  {% block clusters %}{% endblock %}
  <div class="col-md-6">
    <div style="overflow-y: scroll; height: 2400px;">
      <textarea data-index=1 class='solution_editor' id={{ submission.Id }}>
          {{ submission.before }}
      </textarea>
      <form>
          <div class="ui form editor_choice">
              <div class="inline fields">
                  <label id="which_label">You can edit this code.</label>
                  <div class="field">
                      <div class="ui radio checkbox">
                          <input checked=true name="editor_choice" data-mode="original" type="radio">
                          <label>Show original submission</label>
                      </div>
                  </div>
                  <div class="field">
                      <div class="ui radio checkbox">
                          <input name="editor_choice" data-mode="debug" type="radio">
                          <label>Edit code</label>
                      </div>
                  </div>
              </div>
          </div>
      </form>
      <div class="test_code">
          <button data-index=1 class="ui primary button submitCode">Run the tests again</button>
      </div>
      <p class="test_header"><b>Test results:
          <span class="test_results">
          {% if not test_results.test_cases[0].compile_success %}
              <i>Syntax error.</i>{{ test_results.test_cases[0].syntax_error.text }}
          {% elif test_results.overall_success %}
              All tests succeeded!
          {% else %}
              Some tests failed
          {% endif %}</p>
          </span></b>
      </p>
      <!--<p id="detailed_test_header" class="test_header"><b>Detailed test results</b></p>-->
      <table data-index=1 class="table test_results">
          <thead>
              <tr>
                  <th>Test</th>
                  <th>Input</th>
                  <th></th>
                  <th>Result</th>
                  <th>Expected</th>
                  <th class='output'>Output</th>
              </tr>
          </thead>
          {% for test_case in test_results.test_cases %}
          <tbody>
              <tr data-index={{ loop.index }} class="test_case {% if test_case.success %}success{% else %}failure{% endif %}{% if loop.index == 1 %} selected{% endif %}">
                  <td>{{ loop.index }}</td>
                  <td class='input'>{{ test_case.input_values }}</td>
                  <td>&rarr;</td>
                  <td class='result'>{{ test_case.human_readable_result }}</td>
                  <td class='expected'>{{ test_case.expected }}</td>
                  <td class='output'>
                      <div class='terminal_icon'>
                          <img class='terminal_icon' data-index={{ loop.index }} src="/static/img/terminal-small.png"/>
                      </div>
                  </td>
              </tr>
          </tbody>
          {% endfor %}
      </table>

      <!-- 
        Create a display for the stdout for all test cases.
        However, we will hide all but one of the stdouts
      -->
      <p class="output_header"><b>Output</b> (test case <span class='test_case_number'>1</span>)</p>
      {% for test_case in test_results.test_cases %}
      <div class="error_display">
          {%- if not test_case.compile_success -%}
          {%- elif test_case.timeout -%}
              Timeout
          {%- elif not test_case.exec_success -%}
              {{ test_case.exec_exception.type }}: {{ test_case.exec_exception.args }}
          {%- elif not test_case.runtime_success -%}
              {{ test_case.runtime_exception.type }}: {{ test_case.runtime_exception.args }}
          {%- endif %}
      </div>
      <textarea class="stdout_display">
          {%- if stdout in test_case -%}
              {%- if test_case.stdout != "" -%}
                  {{ test_case.stdout }}
              {%- else -%}
                  [This test case produced no console output.]
              {%- endif -%}
          {%- else -%}
              [This test case produced no console output.]
          {%- endif -%}
      </textarea>
      {% endfor %}
    </div>
    
  </div>
  <div class="col-md-3">
    <h3>Instructions for Students</h3>
    <div>{{question_instructions|safe}}</div>
    <h3>Hints</h3>

    <div class="hint">
      {% if hint == None %}
        <i>No hint</i>
        <br>
        <form id="add-hint" class="ui form" action="{{ url_for('add_hint') }}" method="POST">
          <div class="field">
            <textarea name="text" rows=8 cols=40></textarea>
            <input type="hidden" name="cluster_id" value={{cluster_id}}>
            <input type="hidden" name="tab_id" value={{tab_id}}>
            <input type="hidden" name="question_number" value={{question_number}}>
            <input type="hidden" name="filter" value={{current_filter}}>
          </div>
          <div class="field">
            <input class="ui primary button" type="submit" value="Add">
            <a href="#" id="reuse-hints-button">Reuse previous hints</a>
          </div>
          <div id="previous-hints" class="field" style="display: none">
            <label>
              Reuse Previous hints
              <a href="#" id="hide-reuse-hints-button">Hide</a>
            </label>
            {% for previous_hint in previous_hints %}
            <div class="field previous-hint">
              <div id="reuse-checkbox" class="ui radio checkbox">
                <input type="radio" name="fruit" tabindex="0" class="hidden" data-text="{{ previous_hint.text }}">
                <label>{{ previous_hint.text }}</label>
              </div>
            </div>
            {% endfor %}
          </div>
        </form>


      {% else %}
        <div id="show-hint">
        {{hint.text }}
        <br>
        <a href="#" id="edit-hint-button">Edit</a>
        </div>
        <div id="edit-hint" style="display:none;">
          <form class="ui form" action="{{ url_for('update_hint') }}" method="POST">
            <div class="field">
              <textarea name="text" rows=3 cols=40>{{hint.text}}</textarea>
              <input type="hidden" name="cluster_id" value={{cluster_id}}>
              <input type="hidden" name="tab_id" value={{tab_id}}>
              <input type="hidden" name="question_number" value={{question_number}}>
              <input type="hidden" name="filter" value={{current_filter}}>
            </div>
            <input class="ui primary button" type="submit" value="Add">
            <button id="cancel-hint-button" class="ui button">Cancel</button>
          </form>
        </div>
      {% endif %}
    </div>

  </div>
</div>

<script>
$(function() {

    var editor_panes = $(".solution_editor");
    var editors = [];

    // Make the textareas into code editors
    editor_panes.each(function () {
        var editorIndex = $(this).data('index');
        var newEditor = CodeMirror.fromTextArea($(this)[0], {
            lineNumbers: true,
            mode: 'python',
            viewportMargin: Infinity,
            // lineWrapping: true
        });
        editors[editorIndex] = [newEditor,$(this).attr('id')];
        //console.log('editors',editors)
    });


    // Create read-only editors for showing stdout
    var stdoutDisplays = [];
    $('textarea.stdout_display').each(function() {
        var stdoutDisplay = CodeMirror.fromTextArea(this, {
            viewportMargin: Infinity,
            readOnly: true,
        });
        stdoutDisplays.push(stdoutDisplay);
        $(stdoutDisplay.getWrapperElement()).addClass('stdout_display');
    });

    // We only show the output and error messages
    // for one of the test cases at a time
    $('.CodeMirror.stdout_display').css('display', 'none');
    $('.CodeMirror.stdout_display:first').css('display', 'block');
    $('div.error_display').css('display', 'none');
    if ($.trim($('div.error_display:first').text()) !== '') {
        $('div.error_display:first').css('display', 'block');
    }

    // Clicking on the one of the output icons shows the 
    // stdout and exceptions for that test case
    $('img.terminal_icon, tr.test_case').click(function() {

        var testCaseIndex = $(this).data('index');
        $('table.test_results tbody tr').removeClass('selected');
        $($('table.test_results tbody tr')[testCaseIndex - 1]).addClass('selected');
        $('.CodeMirror.stdout_display').css('display', 'none');
        $($('.CodeMirror.stdout_display')[testCaseIndex - 1]).css('display', 'block');
        $('div.error_display').css('display', 'none');
        var targetErrorDisplay = $($('div.error_display')[testCaseIndex - 1])
        if ($.trim(targetErrorDisplay.text()) !== "") {
            targetErrorDisplay.css('display', 'block');
        }

        $('span.test_case_number').text(testCaseIndex);

    });

    var editor = editors[1][0];
    var originalCode = editor.getValue();
    var debuggedCode = originalCode;

    // Control the editor with the checkboxes that let the user
    // control whether they are looking at the student's
    // current submission or a version they can debug.
    $('.checkbox').checkbox({
        onChecked: function() {
            var newMode = $(this).data('mode');
            if (newMode === 'debug') {
                editor.setValue(debuggedCode);
            } else if (newMode === 'original') {
                debuggedCode = editor.getValue();
                editor.setValue(originalCode);
            }
        },
    });

    // If someone starts editing code and they're on the student's code,
    // switch into the debug tab.
    editor.on('change', function() {
        
        // Hacky way of determining if the editor is currently
        // on the student's origina code.  We don't want to just check
        // if we're in 'original' mode, as 'original' may have been set
        // programmatically, which would have triggered this change as
        // we replace the contents of the editor whenever someone
        // clicks on the "original submission" button.
        if (editor.getValue() !== originalCode) {
            $('input[name=editor_choice][data-mode=debug]').prop('checked', true);
        }

    });

    // When the submit button is clicked, run the test cases.
    $('.submitCode').click(function() {

        var thisButton = $(this);
        thisButton.addClass('loading');
        var editorIndex = $(this).data('index');
        //var editor, sol_id
        var editor = editors[editorIndex][0];
        var sol_id = editors[editorIndex][1];
        // console.log('id',editor,editorIndex,sol_id)

        //console.log(this, $(this), $(this).data('before-code'))

        $.post('/evaluate', {
            code: editor.getValue(),
            before_id: sol_id,
            question_number: {{question_number}}
        }, function(results) {

            thisButton.removeClass('loading');

            // Update main test case results
            var firstTestCaseResult = results.test_cases[0];
            var overallResultHtml;
            if (firstTestCaseResult.compile_success === false) {
                overallResultHtml = "Syntax error. " +
                    firstTestCaseResult.syntax_error.msg +
                    " (line " + firstTestCaseResult.syntax_error.lineno +
                    ", character " + firstTestCaseResult.syntax_error.offset + ")";
            } else if (results.overall_success) {
                overallResultHtml = "All tests succeeded.";
            } else if (results.overall_success === false) {
                overallResultHtml = "Some tests failed.";
            }
            $('span.test_results').html(overallResultHtml);

            results.test_cases.forEach(function(result, index) {

                // Update test case results
                var successClass = result['success'] ? 'success' : 'failure';
                var row = $($('table.test_results tbody tr')[index]);
                row.removeClass('success');
                row.removeClass('failure');
                row.addClass(successClass);
                $(row.children()[1]).text(result['input_values']);
                $(row.children()[3]).text(result['human_readable_result']);
                // Update stdout displays
                var stdoutDisplay = stdoutDisplays[index];
                var stdoutDisplayNode = $(stdoutDisplay.getWrapperElement());
                var originalDisplayValue = stdoutDisplayNode.css('display');
                var newStdout;

                if ('stdout' in result && result.stdout !== '') {
                    newStdout = result.stdout;
                } else {
                    newStdout = "[This test case produced no console output.]";
                }

                stdoutDisplayNode.css('display', 'block');
                stdoutDisplays[index].setValue(newStdout);
                stdoutDisplayNode.css('display', originalDisplayValue);

                // Update error displays
                var errorDisplay = $($('div.error_display')[index]);
                var errorMessage = "";
                if (!result.compile_success) {
                } else if (result.timeout) {
                    errorMessage = "Execution took too long.  Server timed out."
                } else if (!result.exec_success) {
                    errorMessage = result.exec_exception.type + ": " + result.exec_exception.args;
                } else if (!result.runtime_success) {
                    errorMessage = result.runtime_exception.type + ": " + result.runtime_exception.args;
                }
                errorDisplay.text(errorMessage);
                if ($.trim(errorDisplay.text()) === "") {
                    errorDisplay.css('display', 'none');
                }

            });
        });

    });
});
</script>
{% endblock %}

